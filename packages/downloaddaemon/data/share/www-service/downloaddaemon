#!/bin/haserl
Content-type: text/html

<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">   
<%in funcs.cgi %>
<%
# TODO: add these to the base system
set_opkg_service_config(){
        sed -ri "s%^${2}=.*%${2}=${3}%g" /opt/etc/config/${1}
}

get_opkg_service_config(){
        echo -n $(sed -n "s/^\(${2}\)=\(.*\)$/\2/p" /opt/etc/config/${1})
}

set_dd_config(){
        sed -ri "s%^${1} = .*%${1} = ${2}%g" /opt/etc/downloaddaemon/downloaddaemon.conf
}

get_dd_config(){
        echo -n $(sed -n "s/^\(${1}\) = \(.*\)$/\2/p" /opt/etc/downloaddaemon/downloaddaemon.conf)
}


DOWNLOADDIR=$(get_opkg_service_config downloaddaemon download_dir)

if [ "${REQUEST_METHOD}" = "POST" ]
then
    ACTION=$(echo ${FORM_action} | cut -d ' ' -f 1)
    case "$ACTION" in
	Apply)
	    DOWNLOADDIR=$(echo ${FORM_shared} | cut -d ' ' -f 1)
	    IS_ENABLED=$(echo ${FORM_enabled} | cut -d ' ' -f 1)
	    set_opkg_service_config downloaddaemon enabled ${IS_ENABLED:-0}
	    set_opkg_service_config downloaddaemon download_dir "${DOWNLOADDIR}"
	    
      	    /opt/etc/init.d/downloadd restart > /dev/null
      	    sleep 2
      	    ;;
      Start)
      	/opt/etc/init.d/downloadd start > /dev/null
      	sleep 2
    	;;
      Stop)
      	/opt/etc/init.d/downloadd stop > /dev/null
      	sleep 3
    	;;
      Restart)
      	/opt/etc/init.d/downloadd restart > /dev/null
      	sleep 2
    	;;
      Done)
        DOWNLOADDIR=/usb/$(echo ${FORM_shared} | cut -d '|' -f 1)
        ;;
      *)
    esac
fi


%>
<script language="JavaScript">
<!-- //

function validateAction(form) {                                             
	var action = btnAction.value;
	var question = "";

	if ( action == 'Apply' ){
		question = "This will restart the downloaddaemon service.";
	}
	else if ( action == 'Stop' )
		question = "Are you sure that you want to stop the downloaddaemon service?";
	else if  ( action == 'Restart' )
		question = "Are you sure that you want to restart downloaddaemon service?";
	else
		return true;
	
	var answer = confirm (question);
	if (answer)   
		return true;                                                 
	else                                                            
		return false;                                           
}



function checkDownloadDaemon(){
	downloaddaemon.shared.value = "<%= ${DOWNLOADDIR} %>";
	if ( <% get_opkg_service_config downloaddaemon enabled %> == 0 ){
		document.forms[0].shared.disabled = true;
	}
}

function fileBrowserNew(){
	filebrowser.submit();
}

function setReadDownloadDaemon(obj){
	if(obj.checked){       
		document.forms[0].shared.disabled = false;
	} 
	else { 
		document.forms[0].shared.disabled = true;
	}
}


// -->
</script>
</head>

<body onload="checkDownloadDaemon();" >

<center>
<TABLE border="0">
<form id=filebrowser name=filebrowser action="./filebrowserd.cgi" method="POST">
  <input type=hidden name=sourceform value="<%= ${SCRIPT_NAME} %>?page=downloaddaemon">
  <TR><TH>Download folder:</TH><TD><input type="text" name="shared" size=20 value="<%= $DOWNLOADDIR %>" readonly onclick="fileBrowserNew()"/></TD></TR>
</form> 
<form id=downloaddaemon name=downloaddaemon action="<%= ${SCRIPT_NAME} %>?page=downloaddaemon" method="POST"  onsubmit="return validateAction(this);">
  <input type=hidden name=shared value="">
  <TR><TH>DownlodDaemon enabled:</TH><TD><input type="checkbox" name="enabled" value="1" <% is_checked $(get_opkg_service_config downloaddaemon enabled) %> onclick="setReadDownloadDaemon(this);"/></TD></TR>
  <TR><TH>Status:</TH><TD><% /opt/etc/init.d/downloadd webstatus %></TD></TR>
</TABLE>

<input type="submit" name="action" value="Apply" onclick="btnAction=this">
  <input type="submit" name="action" value="Start" onclick="btnAction=this">
  <input type="submit" name="action" value="Stop" onclick="btnAction=this">
  <input type="submit" name="action" value="Restart" onclick="btnAction=this">   
</form>

</center>
</body>
</html>
