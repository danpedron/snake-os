#!/bin/haserl
Content-type: text/html

<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">   
<%in funcs.cgi %>
<%
# TODO: add these to the base system
set_opkg_service_config(){
        sed -ri "s%^${2}=.*%${2}=${3}%g" /opt/etc/config/${1}
}

get_opkg_service_config(){
        echo -n $(sed -n "s/^\(${2}\)=\(.*\)$/\2/p" /opt/etc/config/${1})
}

set_minidlna_config(){
        sed -ri "s%^${1}=.*%${1}=${2}%g" /opt/etc/minidlna.conf
}

get_minidlna_config(){
        echo -n $(sed -n "s/^\(${1}\)=\(.*\)$/\2/p" /opt/etc/minidlna.conf)
}


MINIDLNADIR=$(get_minidlna_config media_dir)

if [ "${REQUEST_METHOD}" = "POST" ]
then
    ACTION=$(echo ${FORM_action} | cut -d ' ' -f 1)
    case "$ACTION" in
	Apply)
	    MINIDLNADIR=$(echo ${FORM_shared} | cut -d ' ' -f 1)
	    IS_ENABLED=$(echo ${FORM_enabled} | cut -d ' ' -f 1)
	    set_opkg_service_config minidlna enabled ${IS_ENABLED:-0}
	    
      	    /opt/etc/init.d/minidlna stop > /dev/null
      	    sleep 2
	    
      	    set_minidlna_config media_dir ${MINIDLNADIR}
	    
      	    /opt/etc/init.d/minidlna start > /dev/null
      	    sleep 2
      	    ;;
      Start)
      	/opt/etc/init.d/minidlna start > /dev/null
      	sleep 2
    	;;
      Stop)
      	/opt/etc/init.d/minidlna stop > /dev/null
      	sleep 3
    	;;
      Restart)
      	/opt/etc/init.d/minidlna restart > /dev/null
      	sleep 2
    	;;
      Done)
        MINIDLNADIR=/usb/$(echo ${FORM_shared} | cut -d '|' -f 1)
        ;;
      *)
    esac
fi


%>
<script language="JavaScript">
<!-- //

function validateAction(form) {                                             
	http_port = form.http_port.value;
	var action = btnAction.value;
	var question = "";

	if ( action == 'Apply' ){
		question = "This will restart the minidlna service and set the new folder.";
	}
	else if ( action == 'Stop' )
		question = "Are you sure that you want to stop the minidlna service?";
	else if  ( action == 'Restart' )
		question = "Are you sure that you want to restart minidlna service?";
	else
		return true;
	
	var answer = confirm (question);
	if (answer)   
		return true;                                                 
	else                                                            
		return false;                                           
}



function checkMinidlna(){
	minidlna.shared.value = "<%= ${MINIDLNADIR} %>";
	if ( <% get_opkg_service_config minidlna enabled %> == 0 ){
		document.forms[0].shared.disabled = true;
	}
}

function fileBrowserNew(){
	filebrowser.submit();
}

function setReadMinidlna(obj){
	if(obj.checked){       
		document.forms[0].shared.disabled = false;
	} 
	else { 
		document.forms[0].shared.disabled = true;
	}
}


// -->
</script>
</head>

<body onload="checkMinidlna();" >

<center>
<TABLE border="0">
<form id=filebrowser name=filebrowser action="./filebrowserd.cgi" method="POST">
  <input type=hidden name=sourceform value="<%= ${SCRIPT_NAME} %>?page=minidlna">
  <TR><TH>Shared folder:</TH><TD><input type="text" name="shared" size=20 value="<%= $MINIDLNADIR %>" readonly onclick="fileBrowserNew()"/></TD></TR>
</form> 
<form id=minidlna name=minidlna action="<%= ${SCRIPT_NAME} %>?page=minidlna" method="POST"  onsubmit="return validateAction(this);">
  <input type=hidden name=shared value="">
  <TR><TH>Minidlna enabled:</TH><TD><input type="checkbox" name="enabled" value="1" <% is_checked $(get_opkg_service_config minidlna enabled) %> onclick="setReadMinidlna(this);"/></TD></TR>
  <TR><TH>Status:</TH><TD><% /opt/etc/init.d/minidlna webstatus %></TD></TR>
</TABLE>

<input type="submit" name="action" value="Apply" onclick="btnAction=this">
  <input type="submit" name="action" value="Start" onclick="btnAction=this">
  <input type="submit" name="action" value="Stop" onclick="btnAction=this">
  <input type="submit" name="action" value="Restart" onclick="btnAction=this">   
</form>

</center>
</body>
</html>
