#!/bin/haserl
Content-type: text/html

<html xml:lang="en" xmlns="http://www.w3.org/1999/xhtml" lang="en">   
<%in funcs.cgi %>
<%

# TODO: add these to the base system
set_opkg_service_config(){
        sed -ri "s%^${2}=.*%${2}=${3}%g" /opt/etc/config/${1}
}

get_opkg_service_config(){
        echo -n $(sed -n "s/^\(${2}\)=\(.*\)$/\2/p" /opt/etc/config/${1})
}

get_smbsecmode_sel(){
    if [ $SMBSECMODE = $1 ] ; then
        echo -n "selected"
    fi
}

if [ "${REQUEST_METHOD}" = "POST" ]
then
    ACTION=$(echo ${FORM_action} | cut -d ' ' -f 1)
    case "$ACTION" in
      Start)
      	/opt/etc/init.d/samba3 start > /dev/null
      	sleep 2
    	;;
      Stop)
      	/opt/etc/init.d/samba3 stop > /dev/null
      	sleep 2
    	;;
      Restart)
      	/opt/etc/init.d/samba3 restart > /dev/null
      	sleep 2
    	;;
      Apply)
        SMBENABLE=$(echo ${FORM_samba_enable} | cut -d ' ' -f 1)
      	set_opkg_service_config samba3 samba_enable ${SMBENABLE:-0}
		if [ ${SMBENABLE:-0} = 1 ] ; then
	      	SECMODE=$(echo ${FORM_security} | cut -d ' ' -f 1)
			set_opkg_service_config samba3 smbsecurity ${SECMODE}
			sed -ri "s/security = .*/security = ${SECMODE}/g" /etc/smb.conf
	      	WORKGROUP=$(echo ${FORM_workgroup} | cut -d ' ' -f 1)
			set_opkg_service_config samba3 smbworkgroup ${WORKGROUP}
	      	sed -ri "s/workgroup = .*/workgroup = ${WORKGROUP}/g" /etc/smb.conf
		fi
      	/opt/etc/init.d/samba3 restart > /dev/null
      	sleep 2
    	;;
    	
      *)
    esac
fi

SMBSECMODE=$(get_opkg_service_config samba3 smbsecurity)

samba_form(){
%>
<form action="<%= ${SCRIPT_NAME} %>?page=samba3" method="POST"  onsubmit="return validateAction(this);">
     <TABLE border="0" >
	  <TR><TH>Samba3 enabled:</TH><TD><input type="checkbox" name="samba_enable" value="1" <% is_checked $(get_opkg_service_config samba3 samba_enable) %> onclick="setReadSmb(this);"/></TD></TR>
      <TR><TH>Samba domain/workgroup:</TH><TD><input type="text" name="workgroup" size=20 value=<% get_opkg_service_config samba3 smbworkgroup %> </TD>
      <TR><TH>Samba security mode:</TH><TD> <select name="security">
    <%
    OPTIONS="<option value="SHARE" $(get_smbsecmode_sel SHARE)>Password Only or Anonymous</option>"
    OPTIONS=${OPTIONS}"<option value="USER" $(get_smbsecmode_sel USER)>User and Password Required</option>"
    echo ${OPTIONS}
    %>
    </select></TD></TR>
     
     
     <TR><TH>Status:</TH><TD><% /opt/etc/init.d/samba3 webstatus %></TD></TR>
</TABLE>
   <input type="submit" name="action" value="Apply" onclick="btnAction=this">
   <input type="submit" name="action" value="Start" onclick="btnAction=this">
   <input type="submit" name="action" value="Stop" onclick="btnAction=this">
   <input type="submit" name="action" value="Restart" onclick="btnAction=this">   
</form>
<%
}

%>
<script language="JavaScript">
<!-- //

function validateAction(form) {                                             
    var action = btnAction.value;
    var question = "";
    if ( action == 'Start' )
    	return true;
    else if ( action == 'Stop' )
        question = "This action will disconnect remote users. Are you sure that you want to stop Samba service?";
    else if  ( action == 'Restart' )
        question = "This action will disconnect remote users. Are you sure that you want to restart Samba service?";
    else if  ( action == 'Apply' )
        question = "This action will disconnect remote users. Please review your file shares if changing the security mode. Do you want to continue?";

    var answer = confirm (question);
    if (answer)                                                      
        return true;                                                 
    else                                                            
        return false;                                           
} 
function checkSmb(){              
	if ( <% get_opkg_service_config samba3 samba_enable %> == 0 ){
		document.forms[0].workgroup.disabled = true;
		document.forms[0].security.disabled = true;
	}
}

function setReadSmb(obj){
	if(obj.checked){       
		document.forms[0].workgroup.disabled = false;
		document.forms[0].security.disabled = false;
	} 
	else { 
		document.forms[0].workgroup.disabled = true;
		document.forms[0].security.disabled = true;
	}
}   

// -->
</script>
</head>
<body onload="checkSmb();">                 

<center>
<% 
if [ $(get_config samba_enable) = 1 ]
then
    echo "<b>Builtin samba is enabled.</b><br><br>Please disable the <a href="mg-samba.cgi">samba service</a> before accessing this page."
else
    samba_form
fi
%>

</center>

</body>
</html>
